@startuml
actor Usuario
participant "BuyItemScreen (View)" as View
participant "StoreViewModel" as VM
participant "AuthService" as Auth
participant "BuyItemUseCase" as UseCase
participant "StoreRepository" as Repo
database "AWS MySQL DB\n(UserDao, ItemDao, UserShopDao)" as DB

Usuario -> View: Seleccionar ítem y confirmar compra
View -> VM: onBuyItemClicked(itemId)
VM -> Auth: validateUserPermissions(userId)
Auth --> VM: permisos válidos [Sí/No]

alt Permisos inválidos
    VM -> View: mostrarNoAutorizado()
    note right
        Tipo caso de prueba:
        ❌ Usuario sin permiso (no contemplado explícitamente en hoja de prueba)
    end note

else Permisos válidos
    VM -> Repo: getUserBalance(userId)
    Repo -> DB: consultarSaldoUsuario(userId)
    DB --> Repo: saldo
    Repo --> VM: saldo
    
    VM -> Repo: getInventoryItems(userId)
    Repo -> DB: consultarInventario(userId)
    DB --> Repo: listaItems
    Repo --> VM: listaItems
    
    VM -> Repo: getItemDetails(itemId)
    Repo -> DB: consultarDetallesItem(itemId)
    DB --> Repo: detallesItem
    Repo --> VM: detallesItem

    VM -> UseCase: execute(userId, itemId, saldo, inventario)

    alt Saldo insuficiente
        UseCase -> VM: errorSaldoInsuficiente()
        VM -> View: mostrarSaldoInsuficiente()
        note right
          Tipo caso de prueba: TC2 - Compra sin saldo suficiente
        end note

    else Item duplicado
        UseCase -> VM: errorItemDuplicado()
        VM -> View: mostrarItemDuplicado()
        note right
          Tipo caso de prueba: TC3 - Compra duplicada
        end note

    else Proceso de compra
        UseCase -> Repo: registerTransaction(userId, itemId)
        Repo -> DB: insertarTransaccion(estado=Completed)
        DB --> Repo: confirmación
        Repo -> DB: descontarSaldoYAgregarItem(userId, itemId)
        DB --> Repo: confirmación
        Repo --> UseCase: compraExitosa()
        UseCase --> VM: resultadoExito()
        VM -> View: mostrarConfirmacionCompraExitosa()
        note right
          Tipo caso de prueba:
          TC1 - Compra exitosa
          TC4 - Confirmación visual
          TC5 - Validación integridad de datos
        end note
    end
end
@enduml
